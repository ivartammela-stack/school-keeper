rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function signedIn() {
      return request.auth != null;
    }

    function isSelf(uid) {
      return signedIn() && request.auth.uid == uid;
    }

    function userDoc(uid) {
      return get(/databases/$(database)/documents/users/$(uid));
    }

    function memberDoc(schoolId, uid) {
      return get(/databases/$(database)/documents/schools/$(schoolId)/members/$(uid));
    }

    function isAnyMember(schoolId) {
      return signedIn() && exists(memberDoc(schoolId, request.auth.uid));
    }

    function isMember(schoolId) {
      return signedIn()
        && exists(memberDoc(schoolId, request.auth.uid))
        && memberDoc(schoolId, request.auth.uid).data.status == 'active';
    }

    function isSchoolAdmin(schoolId) {
      return isMember(schoolId)
        && (memberDoc(schoolId, request.auth.uid).data.roles is list)
        && memberDoc(schoolId, request.auth.uid).data.roles.hasAny(['admin']);
    }

    // USERS (self only)
    match /users/{uid} {
      allow read: if isSelf(uid);
      allow create: if isSelf(uid);
      allow update: if isSelf(uid);
      allow delete: if isSelf(uid);

      match /pushTokens/{tokenId} {
        allow read, write: if isSelf(uid);
      }
    }

    // GLOBAL CATALOGS (read for signed-in, write allowed for signed-in)
    match /catalogs/global/{collection}/{docId} {
      allow read: if signedIn();
      allow write: if signedIn();
    }

    // SCHOOLS
    match /schools/{schoolId} {
      allow read: if signedIn();
      allow create: if signedIn();
      allow update, delete: if isSchoolAdmin(schoolId);

      match /members/{uid} {
        allow read: if isMember(schoolId) || isSelf(uid) || isSchoolAdmin(schoolId);
        allow create: if (isSelf(uid)
            && request.resource.data.status == 'pending'
            && (request.resource.data.roles is list)
            && request.resource.data.roles.size() == 0)
          || isSchoolAdmin(schoolId);
        allow update: if isSchoolAdmin(schoolId)
          || (isSelf(uid)
            && request.resource.data.roles == resource.data.roles
            && request.resource.data.status == resource.data.status);
        allow delete: if isSchoolAdmin(schoolId);
      }

      match /tickets/{ticketId} {
        allow read, create, update: if isMember(schoolId);
        allow delete: if isSchoolAdmin(schoolId);

        match /comments/{commentId} {
          allow read, create, update: if isMember(schoolId);
          allow delete: if isSchoolAdmin(schoolId);
        }
      }

      match /catalogs/{docId}/{subCollection=**} {
        allow read: if isMember(schoolId);
        allow write: if isSchoolAdmin(schoolId);
      }

      match /settings/{docId} {
        allow read: if isMember(schoolId);
        allow write: if isSchoolAdmin(schoolId);
      }

      match /templates/{docId} {
        allow read: if isMember(schoolId);
        allow write: if isSchoolAdmin(schoolId);
      }

      match /auditLogs/{docId} {
        allow read: if isSchoolAdmin(schoolId);
        allow write: if isSchoolAdmin(schoolId);
      }

      match /{docPath=**} {
        allow read: if isMember(schoolId);
        allow write: if isSchoolAdmin(schoolId);
      }
    }

    match /mail/{docId} {
      allow read, write: if false;
    }
  }
}
